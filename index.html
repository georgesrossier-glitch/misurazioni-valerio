<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valerio Valeri â€” Misurazioni Pressione & Glicemia</title>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --brand:#1d4ed8;

      --ok:#16a34a;
      --warn:#f59e0b;
      --bad:#dc2626;

      --warnBg:rgba(245,158,11,.12);
      --badBg:rgba(220,38,38,.12);

      --warnBd:rgba(245,158,11,.55);
      --badBd:rgba(220,38,38,.60);

      --shadow: 0 1px 0 rgba(2,6,23,.04), 0 8px 24px rgba(2,6,23,.06);
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(29,78,216,.10), transparent 60%),
                  radial-gradient(900px 600px at 95% 0%, rgba(245,158,11,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1120px;margin:18px auto;padding:0 14px 30px;}

    .header{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:10px;
    }
    h1{margin:0;font-size:20px; letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px;line-height:1.3}

    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      color:var(--text);
      padding:9px 12px;
      border-radius:12px;
      font-size:13px;
      cursor:pointer;
      box-shadow:0 1px 0 rgba(2,6,23,.03);
    }
    .btn.primary{
      border-color:rgba(29,78,216,.25);
      background:rgba(29,78,216,.08);
      color:#0b1f5e;
    }
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background:var(--card);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      box-shadow:0 1px 0 rgba(2,6,23,.03);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#94a3b8}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--bad)}

    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr;
      margin-top:12px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:14px}
    .kv{display:grid; grid-template-columns:150px 1fr; gap:6px 10px; font-size:13px}
    .k{color:var(--muted)}
    .v a{color:var(--brand); text-decoration:none}
    .v a:hover{text-decoration:underline}

    details{border:1px dashed var(--line); border-radius:14px; padding:10px; background:#fafafa}
    summary{cursor:pointer; color:var(--text); font-weight:700}
    .note{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.35}

    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-top:10px;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .chip{
      background:#f1f5f9;
      border:1px solid var(--line);
      color:var(--muted);
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill{width:10px;height:10px;border-radius:999px;display:inline-block}
    .pill.ok{background:var(--ok)}
    .pill.warn{background:var(--warn)}
    .pill.bad{background:var(--bad)}

    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      background:#0b10200d;
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:10px;
      word-break:break-all;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      margin-top:12px;
      overflow:hidden;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      box-shadow: var(--shadow);
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background:linear-gradient(#fbfbfe,#f7f9ff);
      border-bottom:1px solid var(--line);
      font-size:12px;
      color:var(--muted);
      text-align:left;
      padding:10px;
      white-space:nowrap;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px;
      font-size:13px;
      vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover td{background:#fbfbff}

    .lastRow td{ background:rgba(29,78,216,.05); }
    .lastRow td:first-child{ border-left:4px solid rgba(29,78,216,.55); }

    .warnCell{
      background: var(--warnBg);
      border-left:4px solid var(--warnBd);
    }
    .critCell{
      background: var(--badBg);
      border-left:4px solid var(--badBd);
      font-weight:800;
    }
    @keyframes blink {
      0%,100%{filter:brightness(1)}
      50%{filter:brightness(1.35)}
    }
    .blink{animation:blink 1.1s infinite}

    .errBox{
      display:none;
      white-space:pre-line;
      border:1px solid rgba(220,38,38,.25);
      background:rgba(220,38,38,.06);
      color:#7f1d1d;
      border-radius:16px;
      padding:12px;
      margin-top:12px;
      font-size:13px;
    }

    @page { size: A4; margin: 10mm; }
    @media print{
      body{background:#fff}
      .btn, .badge, .sub, .chips, details{display:none !important}
      .wrap{max-width:none; margin:0; padding:0}
      .card, table{box-shadow:none}
      thead th{position:static}
      .warnCell,.critCell{background:transparent !important; font-weight:800}
      .blink{animation:none}
    }
  </style>
</head>

<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Misurazioni Pressione &amp; Glicemia</h1>
      <div class="sub">Aggiornamento automatico dal CSV su Dropbox â€¢ evidenziazione valori critici â€¢ stampa/PDF</div>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnRefresh" type="button">Aggiorna ora</button>
      <button class="btn" type="button" onclick="window.print()">Stampa / Salva PDF</button>
      <div class="badge" id="status"><span class="dot" id="dot"></span><span id="statusText">â€”</span></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Dati del paziente</h2>
      <div class="kv">
        <div class="k">Nome</div><div class="v">Valerio Valeri</div>
        <div class="k">Data di nascita</div><div class="v">09.06.1944</div>
        <div class="k">Indirizzo</div><div class="v">Via alle Scuole, 6814 Cadempino</div>
        <div class="k">Telefono</div><div class="v"><a href="tel:+41919673221">091 967 32 21</a></div>
        <div class="k">Cellulare</div><div class="v"><a href="tel:+41779409704">+41 77 940 97 04</a></div>
        <div class="k">Email</div><div class="v"><a href="mailto:info@ecofix.ch">info@ecofix.ch</a></div>
      </div>
      <div class="note">Nota: pagina per consultazione. Terapia e dati clinici vanno sempre confermati con il medico.</div>
    </div>

    <div class="card">
      <h2>Contatti medici</h2>
      <div class="kv">
        <div class="k">Oncologia â€” Dott. Sebastian Nannini</div><div class="v"><a href="mailto:MauroSebastian.Nannini@eoc.ch">MauroSebastian.Nannini@eoc.ch</a></div>
        <div class="k">Segretariato</div><div class="v"><a href="mailto:segretariatoOncologia.osg@eoc.ch">segretariatoOncologia.osg@eoc.ch</a> â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>
        <div class="k">Oncologia â€” Dr. med. Turco Fabio</div><div class="v">Segretariato â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>
        <div class="k">Medico di base â€” Dr. med. Cereghetti Gabriele</div><div class="v"><a href="mailto:studiogcereghetti@bluewin.ch">studiogcereghetti@bluewin.ch</a> â€¢ <a href="tel:+41919662343">091 966 23 43</a></div>
      </div>

      <details style="margin-top:12px;">
        <summary>ðŸ’Š Terapia in corso (da verificare con il medico)</summary>
        <div class="note" style="margin-top:10px;">
          <strong>Farmaci per diabete</strong><br>
          â€¢ Diamicron MR â€“ al mattino<br>
          â€¢ Januvia â€“ al mattino e alla sera<br><br>

          <strong>Anticoagulante</strong><br>
          â€¢ Eliquis â€“ al mattino e alla sera<br><br>

          <strong>Pressione arteriosa</strong><br>
          â€¢ Coveram 10/10 mg â€“ al mattino (abbassa la pressione)<br><br>

          <strong>Prostata â€“ terapia serale in alternanza</strong><br>
          â€¢ Urorec â€“ alla sera, in alternanza<br>
          â€¢ Proscar â€“ alla sera, in alternanza<br>
          â€¢ Tamsulosin T Sandoz â€“ alla sera, in alternanza (sostituisce il Pradif)<br><br>

          <strong>Nota:</strong> schema riportato dal paziente; confermare e correggere se necessario.
        </div>
      </details>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2>Fonte dati e legenda</h2>
    <div class="row">
      <div class="chips">
        <span class="chip"><span class="pill ok"></span>OK</span>
        <span class="chip"><span class="pill warn"></span>Attenzione</span>
        <span class="chip"><span class="pill bad"></span>Critico (lampeggia)</span>
        <span class="chip">Ultima misurazione evidenziata</span>
      </div>
      <div class="note" style="margin:0;">
        CSV: <code id="csvLabel"></code><br>
        Ultimo aggiornamento: <strong id="lastUpdate">â€”</strong> â€¢ Righe visualizzate: <strong id="rowsCount">â€”</strong>
      </div>
    </div>
    <div class="errBox" id="errBox"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Data</th>
        <th>Ora pressione</th>
        <th>Battiti</th>
        <th>Sistolica</th>
        <th>Diastolica</th>
        <th>Ora glicemia</th>
        <th>Glucosio</th>
        <th>Note / Osservazioni</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="note" style="margin-top:10px;">
    Soglie (mmHg/bpm â€¢ glicemia mmol/L): Pressione alta â‰¥ 140/90 (attenzione), â‰¥ 180/120 (critico). Bassa &lt; 90/60 (critico).
    Battiti &lt; 45 o &gt; 120 (critico). Glicemia: &lt; 3.9 (critico), &gt; 10 (attenzione), â‰¥ 13.9 (critico).
  </div>
</div>

<script>
/** CONFIG â€” LINK DROPBOX PUBBLICO (meglio dl.dropboxusercontent.com) **/
const CSV_URL = "https://dl.dropboxusercontent.com/scl/fi/tfv0v8z4s0sawhcyzzq4y/misure-valerio.csv?rlkey=yj81lfdu1e0kgm4rl03g1pq9j&raw=1";
const CSV_URL_FALLBACK = "https://www.dropbox.com/scl/fi/tfv0v8z4s0sawhcyzzq4y/misure-valerio.csv?rlkey=yj81lfdu1e0kgm4rl03g1pq9j&raw=1";
const REFRESH_MS = 60_000;

/** Soglie **/
const TH = {
  SYS_WARN: 140, DIA_WARN: 90,
  SYS_BAD: 180,  DIA_BAD: 120,
  SYS_LOW_BAD: 90, DIA_LOW_BAD: 60,
  HR_LOW_BAD: 45, HR_HIGH_BAD: 120,
  GLU_LOW_BAD: 3.9, GLU_HIGH_WARN: 10.0, GLU_HIGH_BAD: 13.9
};

const $ = (id)=>document.getElementById(id);
$("csvLabel").textContent = CSV_URL;

function setStatus(ok, text){
  $("statusText").textContent = text;
  $("dot").className = "dot " + (ok ? "ok" : "err");
}
function showErr(msg){
  const box = $("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function clearErr(){
  const box = $("errBox");
  box.style.display = "none";
  box.textContent = "";
}
function nowStr(){
  return new Date().toLocaleString("it-CH", {hour12:false});
}
function toNum(x){
  const n = Number(String(x ?? "").trim().replace(",", "."));
  return Number.isFinite(n) ? n : NaN;
}
function normKey(k){
  return String(k||"").trim().toUpperCase()
    .replaceAll(" ", "_")
    .replaceAll("/", "_")
    .replaceAll(".", "")
    .replaceAll("__", "_");
}

/** CSV parser robusto: trova la riga header vera e sceglie delimitatore **/
function parseCSV(text){
  const lines = text
    .replace(/\r\n/g,"\n")
    .replace(/\r/g,"\n")
    .split("\n")
    .map(l => l.trimEnd());

  const headerIndex = lines.findIndex(l => {
    const u = l.toUpperCase();
    // nel tuo CSV l'header contiene sicuramente DATA e ORA_PRESSIONE
    return u.includes("DATA") && u.includes("ORA_PRESSIONE");
  });
  if (headerIndex < 0) return { headers: [], rows: [] };

  const headerLine = lines[headerIndex];
  const candidates = [";", ",", "\t"];
  let delim = ";", best = -1;
  for(const d of candidates){
    const c = headerLine.split(d).length - 1;
    if(c > best){ best = c; delim = d; }
  }

  const splitLine = (line)=> line.split(delim).map(s=>s.trim());
  const headers = splitLine(headerLine).map(normKey);

  const rows = [];
  for(let i=headerIndex+1;i<lines.length;i++){
    const line = lines[i];
    if(!line || !line.trim()) continue;
    const parts = splitLine(line);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (parts[idx] ?? "").trim());
    rows.push(obj);
  }
  return { headers, rows };
}

function parseDateFlexible(s){
  s = String(s||"").trim();
  if(/^\d{2}\.\d{2}\.\d{4}$/.test(s)){
    const [dd,mm,yy]=s.split(".");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){
    const [dd,mm,yy]=s.split("/");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [yy,mm,dd]=s.split("-");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  return null;
}

/** Mappatura corretta per il tuo CSV:
  Riga dati: 11:00;88;144;50  -> 88=BATTITI, 144=SISTOLICA, 50=DIASTOLICA
  Nel CSV i valori sono finiti sotto intestazioni sbagliate, quindi rimappiamo.
**/
function mapRow(o){
  const dt = parseDateFlexible(o.DATA);
  if(!dt) return null;

  // CSV header: N.;DATA;ORA_PRESSIONE;SISTOLICA;DIASTOLICA;BATTITI;...
  // ma i valori:                88        144        50
  const battiti    = o.SISTOLICA;
  const sistolica  = o.DIASTOLICA;
  const diastolica = o.BATTITI;

  return {
    N: o.N || o.NR || o.N_ || "",
    DATA: o.DATA || "",
    ORA_PRESSIONE: o.ORA_PRESSIONE || "",
    BATTITI: battiti || "",
    SISTOLICA: sistolica || "",
    DIASTOLICA: diastolica || "",
    ORA_GLICEMIA: o.ORA_GLICEMIA || "",
    GLUCOSIO: o.GLUCOSIO || "",
    NOTE: o.NOTE_OSSERVAZIONI || o.NOTE || o.OSSERVAZIONI || ""
  };
}

function classify(r){
  const sys=toNum(r.SISTOLICA), dia=toNum(r.DIASTOLICA), hr=toNum(r.BATTITI), glu=toNum(r.GLUCOSIO);

  const sysCrit = Number.isFinite(sys) && (sys < TH.SYS_LOW_BAD || sys >= TH.SYS_BAD);
  const diaCrit = Number.isFinite(dia) && (dia < TH.DIA_LOW_BAD || dia >= TH.DIA_BAD);
  const hrCrit  = Number.isFinite(hr)  && (hr  < TH.HR_LOW_BAD  || hr  > TH.HR_HIGH_BAD);
  const gluCrit = Number.isFinite(glu) && (glu < TH.GLU_LOW_BAD || glu >= TH.GLU_HIGH_BAD);

  const sysWarn = Number.isFinite(sys) && (!sysCrit && sys >= TH.SYS_WARN);
  const diaWarn = Number.isFinite(dia) && (!diaCrit && dia >= TH.DIA_WARN);
  const gluWarn = Number.isFinite(glu) && (!gluCrit && glu > TH.GLU_HIGH_WARN);

  return {
    HR:  {warn:false, crit:hrCrit},
    SYS: {warn:sysWarn, crit:sysCrit},
    DIA: {warn:diaWarn, crit:diaCrit},
    GLU: {warn:gluWarn, crit:gluCrit}
  };
}

function render(rows){
  const tb = $("tbody");
  tb.innerHTML="";

  rows.forEach((r, idx)=>{
    const tr=document.createElement("tr");
    if(idx===0) tr.classList.add("lastRow");

    const cell = classify(r);

    const td=(txt, classes=[])=>{
      const x=document.createElement("td");
      x.textContent = txt ?? "";
      classes.forEach(c=>x.classList.add(c));
      return x;
    };

    const clsHR=[];  if(cell.HR.crit) clsHR.push("critCell","blink");
    const clsSYS=[]; if(cell.SYS.crit) clsSYS.push("critCell","blink"); else if(cell.SYS.warn) clsSYS.push("warnCell");
    const clsDIA=[]; if(cell.DIA.crit) clsDIA.push("critCell","blink"); else if(cell.DIA.warn) clsDIA.push("warnCell");
    const clsGLU=[]; if(cell.GLU.crit) clsGLU.push("critCell","blink"); else if(cell.GLU.warn) clsGLU.push("warnCell");

    tr.append(
      td(r.N || String(idx+1)),
      td(r.DATA),
      td(r.ORA_PRESSIONE),
      td(r.BATTITI, clsHR),
      td(r.SISTOLICA, clsSYS),
      td(r.DIASTOLICA, clsDIA),
      td(r.ORA_GLICEMIA),
      td(r.GLUCOSIO, clsGLU),
      td(r.NOTE)
    );
    tb.appendChild(tr);
  });

  $("rowsCount").textContent = String(rows.length);
}

async function fetchCSV(){
  const tryFetch = async (u)=>{
    const url = u + (u.includes("?") ? "&" : "?") + "t=" + Date.now();
    const resp = await fetch(url, {cache:"no-store"});
    if(!resp.ok) throw new Error("HTTP " + resp.status);
    const text = await resp.text();
    if(text.trim().startsWith("<!DOCTYPE html") || text.includes("<html")){
      throw new Error("Risposta HTML (non CSV). Controlla che il link sia raw=1 e pubblico.");
    }
    return text;
  };
  try{ return await tryFetch(CSV_URL); }
  catch(_e){ return await tryFetch(CSV_URL_FALLBACK); }
}

async function load(){
  clearErr();
  setStatus(true, "Caricamentoâ€¦");

  try{
    const text = await fetchCSV();
    const parsed = parseCSV(text);

    let rows = parsed.rows.map(mapRow).filter(Boolean);

    // ordina: prima per N desc se numerico, altrimenti per DATA desc
    rows.sort((a,b)=>{
      const na = toNum(a.N), nb = toNum(b.N);
      if(Number.isFinite(na) && Number.isFinite(nb)) return nb - na;
      const da = parseDateFlexible(a.DATA), db = parseDateFlexible(b.DATA);
      if(da && db) return db - da;
      return 0;
    });

    render(rows);
    $("lastUpdate").textContent = nowStr();
    setStatus(true, "OK");
  }catch(e){
    setStatus(false, "Errore");
    showErr(
      "Non riesco a leggere il CSV.\\n\\n" +
      "Dettagli: " + e.message + "\\n\\n" +
      "Suggerimento: apri il link CSV in una scheda: deve mostrare testo CSV (righe con ;), non una pagina Dropbox."
    );
  }
}

$("btnRefresh").addEventListener("click", load);
load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>

    
