<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valerio Valeri â€” Misurazioni Pressione & Glicemia</title>
  <style>
    :root{
      --bg:#f7f8fb;
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --brand:#2563eb;
      --ok:#16a34a;
      --warn:#d97706;
      --bad:#dc2626;
      --chip:#f3f4f6;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px 30px;}
    .header{
      display:flex; gap:14px; align-items:flex-end; justify-content:space-between; flex-wrap:wrap;
      margin-bottom:10px;
    }
    h1{margin:0;font-size:20px; letter-spacing:.2px}
    .sub{margin-top:4px;color:var(--muted);font-size:13px}
    .actions{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line); background:var(--card); color:var(--text);
      padding:9px 12px; border-radius:12px; font-size:13px; cursor:pointer;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .btn.primary{border-color:rgba(37,99,235,.35); background:rgba(37,99,235,.08); color:#0b1f5e}
    .badge{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line); background:var(--card);
      padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:999px;background:#9ca3af}
    .dot.ok{background:var(--ok)}
    .dot.err{background:var(--bad)}
    .grid{
      display:grid; gap:12px;
      grid-template-columns: 1fr 1fr;
      margin-top:12px;
    }
    @media (max-width: 900px){ .grid{grid-template-columns:1fr;} }

    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:16px; padding:14px;
      box-shadow:0 1px 0 rgba(0,0,0,.03);
    }
    .card h2{margin:0 0 10px 0;font-size:14px}
    .kv{display:grid; grid-template-columns:150px 1fr; gap:6px 10px; font-size:13px}
    .k{color:var(--muted)}
    .v a{color:var(--brand); text-decoration:none}
    .v a:hover{text-decoration:underline}

    details{border:1px dashed var(--line); border-radius:14px; padding:10px; background:#fafafa}
    summary{cursor:pointer; color:var(--text); font-weight:600}
    .note{color:var(--muted); font-size:12px; margin-top:8px; line-height:1.35}
    .row{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
      margin-top:10px;
    }
    .chips{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .chip{
      background:var(--chip); border:1px solid var(--line); color:var(--muted);
      padding:6px 10px; border-radius:999px; font-size:12px;
    }
    code{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px; background:#0b10200d; border:1px solid var(--line);
      padding:2px 6px; border-radius:10px;
      word-break:break-all;
    }

    table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; overflow:hidden;
      border:1px solid var(--line); border-radius:16px; background:var(--card);
    }
    thead th{
      position:sticky; top:0; z-index:2;
      background:#fbfbfe; border-bottom:1px solid var(--line);
      font-size:12px; color:var(--muted); text-align:left; padding:10px;
    }
    tbody td{
      border-bottom:1px solid var(--line);
      padding:10px; font-size:13px; vertical-align:top;
    }
    tbody tr:last-child td{border-bottom:none}
    tbody tr:hover td{background:#fbfbff}

    .lastRow td{outline:2px solid rgba(37,99,235,.25); outline-offset:-2px}
    .warnCell{outline:2px solid rgba(217,119,6,.30); outline-offset:-2px; border-radius:10px}
    .critCell{outline:2px solid rgba(220,38,38,.35); outline-offset:-2px; border-radius:10px}
    @keyframes blink {0%,100%{filter:brightness(1)} 50%{filter:brightness(1.9)}}
    .blink{animation:blink .9s infinite}

    .errBox{
      display:none; white-space:pre-line;
      border:1px solid rgba(220,38,38,.25);
      background:rgba(220,38,38,.06);
      color:#7f1d1d;
      border-radius:16px; padding:12px; margin-top:12px;
      font-size:13px;
    }

    /* Print */
    @page { size: A4; margin: 10mm; }
    @media print{
      body{background:#fff}
      .btn, .badge, .note, details, .chips, .sub{display:none !important}
      .wrap{max-width:none; margin:0; padding:0}
      .card{box-shadow:none}
      thead th{position:static}
    }
  </style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div>
      <h1>Misurazioni Pressione & Glicemia</h1>
      <div class="sub">Layout chiaro per consultazione e stampa â€¢ aggiornamento automatico dal CSV su Dropbox</div>
    </div>
    <div class="actions">
      <button class="btn primary" id="btnRefresh" type="button">Aggiorna</button>
      <button class="btn" type="button" onclick="window.print()">Stampa / Salva PDF</button>
      <div class="badge" id="status"><span class="dot" id="dot"></span><span id="statusText">â€”</span></div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <h2>Dati del paziente</h2>
      <div class="kv">
        <div class="k">Nome</div><div class="v">Valerio Valeri</div>
        <div class="k">Data di nascita</div><div class="v">09.06.1944</div>
        <div class="k">Indirizzo</div><div class="v">Via alle Scuole, 6814 Cadempino</div>
        <div class="k">Telefono</div><div class="v"><a href="tel:+41919673221">091 967 32 21</a></div>
        <div class="k">Cellulare</div><div class="v"><a href="tel:+41779409704">+41 77 940 97 04</a></div>
        <div class="k">Email</div><div class="v"><a href="mailto:info@ecofix.ch">info@ecofix.ch</a></div>
      </div>
      <div class="note">
        Nota: questa pagina legge un CSV pubblico su Dropbox. Per farla funzionare serve un hosting che esegua lâ€™HTML (es. Netlify).
      </div>
    </div>

    <div class="card">
      <h2>Contatti medici</h2>
      <div class="kv">
        <div class="k">Oncologia â€” Dott. Sebastian Nannini</div><div class="v"><a href="mailto:MauroSebastian.Nannini@eoc.ch">MauroSebastian.Nannini@eoc.ch</a></div>
        <div class="k">Segretariato</div><div class="v"><a href="mailto:segretariatoOncologia.osg@eoc.ch">segretariatoOncologia.osg@eoc.ch</a> â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>
        <div class="k">Oncologia â€” Dr. med. Turco Fabio</div><div class="v">Segretariato â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>
        <div class="k">Medico di base â€” Dr. med. Cereghetti Gabriele</div><div class="v"><a href="mailto:studiogcereghetti@bluewin.ch">studiogcereghetti@bluewin.ch</a> â€¢ <a href="tel:+41919662343">091 966 23 43</a></div>
      </div>
      <details style="margin-top:12px;">
        <summary>ðŸ’Š Terapia in corso (da verificare con il medico)</summary>
        <div class="note" style="margin-top:10px;">
          <strong>Farmaci per diabete</strong><br>
          â€¢ Diamicron MR â€“ al mattino<br>
          â€¢ Januvia â€“ al mattino e alla sera<br><br>

          <strong>Anticoagulante</strong><br>
          â€¢ Eliquis â€“ al mattino e alla sera<br><br>

          <strong>Pressione arteriosa</strong><br>
          â€¢ Coveram 10/10 mg â€“ al mattino (abbassa la pressione)<br><br>

          <strong>Prostata â€“ terapia serale in alternanza</strong><br>
          â€¢ Urorec â€“ alla sera, in alternanza<br>
          â€¢ Proscar â€“ alla sera, in alternanza<br>
          â€¢ Tamsulosin T Sandoz â€“ alla sera, in alternanza (sostituisce il Pradif)<br><br>

          <strong>Nota:</strong> schema riportato dal paziente; confermare e correggere se necessario.
        </div>
      </details>
    </div>
  </div>

  <div class="card" style="margin-top:12px;">
    <h2>Fonte dati e filtri</h2>
    <div class="row">
      <div class="chips">
        <span class="chip">Evidenza ultima misurazione</span>
        <span class="chip">Lampeggio solo celle critiche</span>
        <span class="chip">Stampa: ultimo mese</span>
      </div>
      <div class="note" style="margin:0;">
        CSV: <code id="csvLabel"></code><br>
        Ultimo aggiornamento: <strong id="lastUpdate">â€”</strong> â€¢ Righe visualizzate: <strong id="rowsCount">â€”</strong>
      </div>
    </div>
    <div class="errBox" id="errBox"></div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Data</th>
        <th>Ora pressione</th>
        <th>Battiti</th>
        <th>Sistolica</th>
        <th>Diastolica</th>
        <th>Ora glicemia</th>
        <th>Glucosio</th>
        <th>Note / Osservazioni</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>

  <div class="note" style="margin-top:10px;">
    Soglie (modificabili nel codice): Pressione alta â‰¥ 140/90 (warning), â‰¥ 180/120 (critico). Bassa &lt; 90/60 (critico).
    Battiti &lt; 45 o &gt; 120 (critico). Glicemia mmol/L: &lt; 3.9 (critico), &gt; 10 (warning), â‰¥ 13.9 (critico).
  </div>
</div>

<script>
/** CONFIG **/
// Link Dropbox "raw=1" del CSV
const CSV_URL = "https://www.dropbox.com/scl/fi/tfv0v8z4s0sawhcyzzq4y/misure-valerio-1.csv?rlkey=yj81lfdu1e0kgm4rl03g1pq9j&raw=1";
// fallback host (spesso piÃ¹ stabile)
const CSV_URL_FALLBACK = "https://dl.dropboxusercontent.com/scl/fi/tfv0v8z4s0sawhcyzzq4y/misure-valerio-1.csv?rlkey=yj81lfdu1e0kgm4rl03g1pq9j&raw=1";

const REFRESH_MS = 60_000;
const LAST_DAYS_PRINT = 30;

// Soglie
const TH = {
  SYS_WARN: 140, DIA_WARN: 90,
  SYS_BAD: 180,  DIA_BAD: 120,
  SYS_LOW_BAD: 90, DIA_LOW_BAD: 60,
  HR_LOW_BAD: 45, HR_HIGH_BAD: 120,
  GLU_LOW_BAD: 3.9, GLU_HIGH_WARN: 10.0, GLU_HIGH_BAD: 13.9
};

const $ = (id)=>document.getElementById(id);
$("csvLabel").textContent = CSV_URL;

function setStatus(ok, text){
  $("statusText").textContent = text;
  const d = $("dot");
  d.className = "dot " + (ok ? "ok" : "err");
}

function showErr(msg){
  const box = $("errBox");
  box.style.display = "block";
  box.textContent = msg;
}
function clearErr(){
  const box = $("errBox");
  box.style.display = "none";
  box.textContent = "";
}

function nowStr(){
  return new Date().toLocaleString("it-CH", {hour12:false});
}

function toNum(x){
  const n = Number(String(x ?? "").trim().replace(",", "."));
  return Number.isFinite(n) ? n : NaN;
}

function normKey(k){
  return String(k||"").trim().toUpperCase()
    .replaceAll(" ", "_")
    .replaceAll("/", "_")
    .replaceAll(".", "")
    .replaceAll("__", "_");
}

// CSV parser semplice: supporta ; o , e virgolette
function parseCSV(text){
  const lines = text.replace(/\r\n/g,"\n").replace(/\r/g,"\n").split("\n").filter(l=>l.trim().length);
  if(lines.length === 0) return {headers:[], rows:[]};

  const sniff = (lines[0].includes(";") && !lines[0].includes(",")) ? ";" : ";";
  // preferiamo ; perchÃ© i tuoi file spesso lo usano; se non c'Ã¨, poi cadremo su ','.
  const delim = lines[0].includes(";") ? ";" : (lines[0].includes(",") ? "," : sniff);

  const splitLine = (line)=>{
    const out=[]; let cur=""; let q=false;
    for(let i=0;i<line.length;i++){
      const ch=line[i];
      if(ch === '"'){ q = !q; continue; }
      if(!q && ch === delim){ out.push(cur); cur=""; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(s=>s.trim());
  };

  const headers = splitLine(lines[0]).map(normKey);
  const rows = [];
  for(let i=1;i<lines.length;i++){
    const parts = splitLine(lines[i]);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (parts[idx] ?? "").trim());
    rows.push(obj);
  }
  return {headers, rows};
}

function parseDateFlexible(s){
  s = String(s||"").trim();
  if(/^\d{2}\.\d{2}\.\d{4}$/.test(s)){
    const [dd,mm,yy]=s.split(".");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  if(/^\d{2}\/\d{2}\/\d{4}$/.test(s)){
    const [dd,mm,yy]=s.split("/");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)){
    const [yy,mm,dd]=s.split("-");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  return null;
}

function inLastDays(dt, days){
  const now=new Date();
  const from=new Date();
  from.setDate(now.getDate()-days);
  return dt && dt>=from && dt<=now;
}

function classify(r){
  const sys=toNum(r.SISTOLICA), dia=toNum(r.DIASTOLICA), hr=toNum(r.BATTITI), glu=toNum(r.GLUCOSIO);
  const cell={HR:{warn:false,crit:false}, SYS:{warn:false,crit:false}, DIA:{warn:false,crit:false}, GLU:{warn:false,crit:false}};

  if(Number.isFinite(sys) && sys < TH.SYS_LOW_BAD) cell.SYS.crit=true;
  if(Number.isFinite(dia) && dia < TH.DIA_LOW_BAD) cell.DIA.crit=true;

  if(Number.isFinite(sys) && sys >= TH.SYS_BAD) cell.SYS.crit=true;
  else if(Number.isFinite(sys) && sys >= TH.SYS_WARN) cell.SYS.warn=true;

  if(Number.isFinite(dia) && dia >= TH.DIA_BAD) cell.DIA.crit=true;
  else if(Number.isFinite(dia) && dia >= TH.DIA_WARN) cell.DIA.warn=true;

  if(Number.isFinite(hr) && (hr < TH.HR_LOW_BAD || hr > TH.HR_HIGH_BAD)) cell.HR.crit=true;

  if(Number.isFinite(glu) && (glu < TH.GLU_LOW_BAD || glu >= TH.GLU_HIGH_BAD)) cell.GLU.crit=true;
  else if(Number.isFinite(glu) && glu > TH.GLU_HIGH_WARN) cell.GLU.warn=true;

  return cell;
}

function mapRow(o){
  // Ignora righe tipo "AGGIORNATO ..." dove manca DATA valida
  const dt = parseDateFlexible(o.DATA);
  if(!dt) return null;
  return {
    N: o.N || o.NR || "",
    DATA: o.DATA || "",
    ORA_PRESSIONE: o.ORA_PRESSIONE || "",
    BATTITI: o.BATTITI || "",
    SISTOLICA: o.SISTOLICA || "",
    DIASTOLICA: o.DIASTOLICA || "",
    ORA_GLICEMIA: o.ORA_GLICEMIA || "",
    GLUCOSIO: o.GLUCOSIO || "",
    NOTE: o.NOTE_OSSERVAZIONI || o.NOTE || o.OSSERVAZIONI || ""
  };
}

function render(rows){
  const tb = $("tbody");
  tb.innerHTML="";

  rows.forEach((r, idx)=>{
    const tr=document.createElement("tr");
    if(idx===0) tr.classList.add("lastRow");

    const cell = classify(r);

    const td=(txt, classes=[])=>{
      const x=document.createElement("td");
      x.textContent = txt ?? "";
      classes.forEach(c=>x.classList.add(c));
      return x;
    };

    const clsHR=[];
    if(cell.HR.crit) clsHR.push("critCell","blink");

    const clsSYS=[];
    if(cell.SYS.crit) clsSYS.push("critCell","blink");
    else if(cell.SYS.warn) clsSYS.push("warnCell");

    const clsDIA=[];
    if(cell.DIA.crit) clsDIA.push("critCell","blink");
    else if(cell.DIA.warn) clsDIA.push("warnCell");

    const clsGLU=[];
    if(cell.GLU.crit) clsGLU.push("critCell","blink");
    else if(cell.GLU.warn) clsGLU.push("warnCell");

    tr.append(
      td(r.N || String(idx+1)),
      td(r.DATA),
      td(r.ORA_PRESSIONE),
      td(r.BATTITI, clsHR),
      td(r.SISTOLICA, clsSYS),
      td(r.DIASTOLICA, clsDIA),
      td(r.ORA_GLICEMIA),
      td(r.GLUCOSIO, clsGLU),
      td(r.NOTE)
    );
    tb.appendChild(tr);
  });

  $("rowsCount").textContent = String(rows.length);
}

async function fetchCSV(){
  const tryFetch = async (u)=>{
    const url = u + (u.includes("?") ? "&" : "?") + "t=" + Date.now();
    const resp = await fetch(url, {cache:"no-store"});
    const text = await resp.text();
    if(text.trim().startsWith("<!DOCTYPE html") || text.includes("<html")){
      throw new Error("Risposta HTML (non CSV).");
    }
    return text;
  };

  try{ return await tryFetch(CSV_URL); }
  catch(_e){ return await tryFetch(CSV_URL_FALLBACK); }
}

function isPrint(){
  return window.matchMedia && window.matchMedia("print").matches;
}

async function load(){
  clearErr();
  setStatus(true, "Caricamentoâ€¦");

  try{
    const text = await fetchCSV();
    const parsed = parseCSV(text);

    // Normalizza keys giÃ  in parseCSV, ora mappa
    let rows = parsed.rows
      .map(mapRow)
      .filter(Boolean);

    // Ordina: prima N (se presente), altrimenti DATA
    rows.sort((a,b)=>{
      const na = toNum(a.N), nb = toNum(b.N);
      if(Number.isFinite(na) && Number.isFinite(nb)) return nb - na;
      const da = parseDateFlexible(a.DATA), db = parseDateFlexible(b.DATA);
      if(da && db) return db - da;
      return 0;
    });

    // In stampa: ultimo mese
    if(isPrint()){
      const filtered = rows.filter(r => inLastDays(parseDateFlexible(r.DATA), LAST_DAYS_PRINT));
      rows = filtered.length ? filtered : rows.slice(0, 25);
    }

    render(rows);
    $("lastUpdate").textContent = nowStr();
    setStatus(true, "OK");
  }catch(e){
    setStatus(false, "Errore");
    showErr(
      "Non riesco a leggere il CSV.\n\n" +
      "Causa tipica: la pagina non Ã¨ ospitata (serve un hosting tipo Netlify) oppure permessi Dropbox.\n\n" +
      "Dettagli: " + e.message + "\n\n" +
      "Test: apri il link CSV in una scheda del browser: deve mostrarti testo CSV, non una pagina Dropbox."
    );
  }
}

$("btnRefresh").addEventListener("click", load);
load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
