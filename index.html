<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Valerio Valeri â€” Misurazioni Pressione & Glicemia</title>
  <style>
    :root {
      --bg:#f6f8fb; --card:#ffffff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --brand:#2563eb; --ok:#16a34a; --warn:#d97706; --bad:#dc2626;
      --shadow:0 10px 30px rgba(2,6,23,.08); --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:var(--sans)}
    .wrap{max-width:1100px;margin:28px auto;padding:0 16px}
    .top{display:flex;gap:14px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    h1{margin:0;font-size:22px;letter-spacing:.2px}
    .sub{margin-top:6px;color:var(--muted);font-size:13px}
    .card{background:var(--card);border:1px solid rgba(2,6,23,.06);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-top:14px}
    @media (max-width: 880px){.grid{grid-template-columns:1fr}}
    .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 12px;font-size:14px}
    .k{color:var(--muted)}
    .v a{color:var(--brand);text-decoration:none}
    .v a:hover{text-decoration:underline}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{appearance:none;border:1px solid rgba(2,6,23,.10);background:#fff;border-radius:999px;padding:9px 12px;font-size:13px;cursor:pointer}
    .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn:active{transform:translateY(1px)}
    .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid rgba(2,6,23,.10);background:#fff;border-radius:999px;padding:7px 10px;font-size:12px;color:var(--muted)}
    .dot{width:10px;height:10px;border-radius:999px;background:var(--muted)}
    .dot.ok{background:var(--ok)} .dot.warn{background:var(--warn)} .dot.bad{background:var(--bad)}
    .pill{font-size:12px;padding:2px 8px;border-radius:999px;border:1px solid rgba(2,6,23,.10);color:var(--muted);background:#fff}
    .err{display:none;white-space:pre-line;border:1px solid rgba(220,38,38,.25);background:rgba(220,38,38,.06);color:#7f1d1d;border-radius:14px;padding:12px;margin-top:12px;font-size:13px}
    table{width:100%;border-collapse:separate;border-spacing:0;margin-top:12px;border:1px solid rgba(2,6,23,.08);border-radius:16px;overflow:hidden;background:#fff}
    thead th{text-align:left;font-size:12px;color:var(--muted);padding:10px 10px;border-bottom:1px solid var(--line);background:#fbfcfe}
    tbody td{padding:10px 10px;border-bottom:1px solid var(--line);font-size:13px;vertical-align:top}
    tbody tr:last-child td{border-bottom:none}
    .num{font-family:var(--mono);font-variant-numeric:tabular-nums}
    .row-warn{background:rgba(217,119,6,.08)}
    .row-bad{background:rgba(220,38,38,.08)}
    @keyframes blink {0%,100%{filter:brightness(1)} 50%{filter:brightness(1.35)}}
    .blink{animation:blink 1.1s infinite}
    .note{color:var(--muted);font-size:12px;margin-top:10px;line-height:1.35}
    @media print {
      body{background:#fff}
      .btn, .badge{display:none !important}
      .card{box-shadow:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>Valerio Valeri â€” Misurazioni Pressione &amp; Glicemia</h1>
          <div class="sub">Aggiornamento automatico da CSV Dropbox â€¢ Refresh ogni 60 secondi</div>
        </div>
        <div class="actions">
          <button class="btn primary" id="btnRefresh" type="button">Aggiorna ora</button>
          <button class="btn" id="btnShowAll" type="button">Mostra tutto</button>
          <button class="btn" id="btnLast25" type="button">Ultime 25</button>
          <button class="btn" id="btnLastMonth" type="button">Ultimo mese</button>
          <button class="btn" type="button" onclick="window.print()">Stampa / Salva PDF</button>
          <div class="badge" id="status"><span class="dot" id="dot"></span><span id="statusText">â€”</span></div>
        </div>
      </div>

      <div class="err" id="errBox"></div>

      <div class="note" id="meta">
        CSV: <span class="num">https://www.dropbox.com/scl/fi/tfv0v8z4s0sawhcyzzq4y/misure-valerio-1.csv?rlkey=yj81lfdu1e0kgm4rl03g1pq9j&raw=1</span><br/>
        Filtro: <span class="pill" id="filterPill">Ultime 25</span> â€¢
        Ultimo aggiornamento: <span class="num" id="lastUpdate">â€”</span> â€¢
        Righe visualizzate: <span class="num" id="rowCount">0</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 style="margin:0 0 10px 0;font-size:16px">Dati del paziente</h2>
        <div class="kv">
          <div class="k">Nome</div><div class="v">Valerio Valeri</div>
          <div class="k">Data di nascita</div><div class="v">09.06.1944</div>
          <div class="k">Indirizzo</div><div class="v">Via alle Scuole, 6814 Cadempino</div>
          <div class="k">Telefono</div><div class="v"><a href="tel:+41919673221">ðŸ“ž 091 967 32 21</a></div>
          <div class="k">Cellulare</div><div class="v"><a href="tel:+41779409704">+41 77 940 97 04</a></div>
          <div class="k">Email</div><div class="v"><a href="mailto:info@ecofix.ch">info@ecofix.ch</a></div>
        </div>
      </div>

      <div class="card">
        <h2 style="margin:0 0 10px 0;font-size:16px">Contatti medici</h2>
        <div class="kv">
          <div class="k">Oncologia â€” Dott. Sebastian Nannini</div><div class="v"><a href="mailto:MauroSebastian.Nannini@eoc.ch">MauroSebastian.Nannini@eoc.ch</a></div>
          <div class="k">Segretariato</div><div class="v"><a href="mailto:segretariatoOncologia.osg@eoc.ch">segretariatoOncologia.osg@eoc.ch</a> â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>

          <div class="k">Oncologia â€” Dr. med. Turco Fabio (Capoclinica)</div><div class="v"><span class="muted">Segretariato</span> â€¢ <a href="mailto:segretariatoOncologia.osg@eoc.ch">segretariatoOncologia.osg@eoc.ch</a> â€¢ <a href="tel:+41918118456">+41 (0)91 811 84 56</a></div>

          <div class="k">Medico di base â€” Dr. med. Cereghetti Gabriele</div><div class="v"><a href="mailto:studiogcereghetti@bluewin.ch">studiogcereghetti@bluewin.ch</a> â€¢ <a href="tel:+41919662343">ðŸ“ž 091 966 23 43</a></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px">
      <h2 style="margin:0 0 10px 0;font-size:16px">Misurazioni</h2>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Data</th>
            <th>Ora pressione</th>
            <th>Battiti</th>
            <th>Sistolica</th>
            <th>Diastolica</th>
            <th>Ora glicemia</th>
            <th>Glucosio (mmol/L)</th>
            <th>Note</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9" style="padding:14px;color:var(--muted)">Caricamentoâ€¦</td></tr>
        </tbody>
      </table>

      <div class="note">
        Soglie (modificabili nel codice):
        Pressione alta â‰¥ 140/90 (warning), â‰¥ 180/120 (critico). Bassa &lt; 90/60 (critico).
        Battiti &lt; 45 o &gt; 120 (critico).
        Glicemia mmol/L: &lt; 3.9 (critico), &gt; 10 (warning), â‰¥ 13.9 (critico).
      </div>
    </div>
  </div>

<script>
const CSV_URL = "https://www.dropbox.com/scl/fi/hcyrnmmmxtukr1uhxxxmv/misure-valerio-1.csv?rlkey=ctuiox7e20xgxj4kmuwaj2v81&raw=1";


const REFRESH_MS = 60_000;

let filterMode = "last25"; // last25 | all | lastMonth
const $$ = (id)=>document.getElementById(id);

function setStatus(kind, text){
  const dot = $$("dot");
  dot.className = "dot" + (kind ? (" "+kind) : "");
  $$("statusText").textContent = text;
}

function showErr(msg){
  const box = $$("errBox");
  box.style.display = "block";
  box.textContent = msg;
}

function hideErr(){
  const box = $$("errBox");
  box.style.display = "none";
  box.textContent = "";
}

function detectDelimiter(line){
  const counts = {
    ";": (line.match(/;/g)||[]).length,
    ",": (line.match(/,/g)||[]).length,
    "\t": (line.match(/\t/g)||[]).length,
  };
  let best = ";";
  for(const k of Object.keys(counts)) if(counts[k] > counts[best]) best = k;
  return best === "\t" ? "\t" : best;
}

function normKey(k){
  return String(k||"").trim().toUpperCase()
    .replaceAll(" ", "_")
    .replaceAll("/", "_")
    .replaceAll(".", "")
    .replaceAll("__", "_");
}

function splitCSVLine(line, delim){
  const out = [];
  let cur = "";
  let q = false;
  for(let i=0;i<line.length;i++) {
    const ch = line[i];
    if(ch === '"') {
      if(q && line[i+1] === '"') { cur += '"'; i++; continue; }
      q = !q; continue;
    }
    if(!q && ch === delim) { out.push(cur.trim()); cur=""; continue; }
    cur += ch;
  }
  out.push(cur.trim());
  return out;
}

function parseCSV(text){
  const lines = text
    .replace(/^\uFEFF/, "")
    .replace(/\r\n/g,"\n")
    .replace(/\r/g,"\n")
    .split("\n")
    .map(l => l.trimEnd());

  const headerIndex = lines.findIndex(l => {
    const u = l.toUpperCase();
    return u.includes("DATA") && u.includes("ORA_PRESSIONE");
  });
  if(headerIndex < 0) return { headers: [], rows: [] };

  const headerLine = lines[headerIndex];
  const delim = detectDelimiter(headerLine);
  const headers = splitCSVLine(headerLine, delim).map(normKey);

  const rows = [];
  for(let i=headerIndex+1;i<lines.length;i++) {
    const line = lines[i];
    if(!line || !line.trim()) continue;
    if(line.toUpperCase().startsWith("AGGIORNATO")) continue;

    const parts = splitCSVLine(line, delim);
    const obj = {};
    headers.forEach((h,idx)=> obj[h] = (parts[idx] ?? "").trim());
    if(!obj.DATA) continue;
    rows.push(obj);
  }
  return { headers, rows };
}

function parseDateFlexible(s){
  s = String(s||"").trim();
  if(/^\d{2}\.\d{2}\.\d{4}$/.test(s)) {
    const [dd,mm,yy]=s.split(".");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  if(/^\d{4}-\d{2}-\d{2}$/.test(s)) {
    const [yy,mm,dd]=s.split("-");
    const d=new Date(+yy, +mm-1, +dd);
    return isNaN(d.getTime())?null:d;
  }
  return null;
}

function toNum(x){
  if(x===null||x===undefined) return null;
  const s=String(x).trim().replace(",",".");
  if(!s) return null;
  const n=Number(s);
  return Number.isFinite(n) ? n : null;
}

function getNote(o){
  // Try common variants produced by different exporters
  const keys = [
    "NOTE", "NOTE_OSSERVAZIONI", "NOTE__OSSERVAZIONI", "NOTE___OSSERVAZIONI",
    "NOTE__/_OSSERVAZIONI", "NOTE_/_OSSERVAZIONI"
  ];
  for(const k of keys) {
    if(o[k]) return o[k];
  }
  return "";
}

function mapRow(o){
  const dt = parseDateFlexible(o.DATA);
  if(!dt) return null;
  return {
    N: o.N || o.NR || "",
    DATA: o.DATA || "",
    ORA_PRESSIONE: o.ORA_PRESSIONE || "",
    SISTOLICA: toNum(o.SISTOLICA),
    DIASTOLICA: toNum(o.DIASTOLICA),
    BATTITI: toNum(o.BATTITI),
    ORA_GLICEMIA: o.ORA_GLICEMIA || "",
    GLUCOSIO: toNum(o.GLUCOSIO),
    NOTE: getNote(o)
  };
}

function classify(row){
  const sys = row.SISTOLICA, dia=row.DIASTOLICA, hr=row.BATTITI, gl=row.GLUCOSIO;
  if(sys!==null && dia!==null) {
    if(sys>=180 || dia>=120) return "bad";
    if(sys<90 || dia<60) return "bad";
    if(sys>=140 || dia>=90) return "warn";
  }
  if(hr!==null && (hr<45 || hr>120)) return "bad";
  if(gl!==null) {
    if(gl<3.9) return "bad";
    if(gl>=13.9) return "bad";
    if(gl>10) return "warn";
  }
  return "";
}

function applyFilter(rows){
  const sorted = [...rows].sort((a,b)=>parseDateFlexible(b.DATA)-parseDateFlexible(a.DATA));
  if(filterMode==="all") return sorted;
  if(filterMode==="last25") return sorted.slice(0,25);
  if(filterMode==="lastMonth") {
    const now = new Date();
    const from = new Date(now.getFullYear(), now.getMonth()-1, now.getDate());
    return sorted.filter(r => {
      const d = parseDateFlexible(r.DATA);
      return d && d >= from;
    });
  }
  return sorted.slice(0,25);
}

function render(rows){
  const tbody = $$("tbody");
  tbody.innerHTML = "";

  if(!rows.length){
    const tr=document.createElement("tr");
    tr.innerHTML = `<td colspan="9" style="padding:14px;color:var(--muted)">
      Nessuna riga da mostrare (controlla filtro o dati nel CSV).
    </td>`;
    tbody.appendChild(tr);
    $$("rowCount").textContent = "0";
    return;
  }

  rows.forEach((r, idx)=>{
    const sev = classify(r);
    const tr=document.createElement("tr");
    if(sev==="warn") tr.classList.add("row-warn");
    if(sev==="bad") tr.classList.add("row-bad","blink");

    tr.innerHTML = `
      <td class="num">${r.N || (idx+1)}</td>
      <td class="num">${r.DATA}</td>
      <td class="num">${r.ORA_PRESSIONE||""}</td>
      <td class="num">${r.BATTITI ?? ""}</td>
      <td class="num">${r.SISTOLICA ?? ""}</td>
      <td class="num">${r.DIASTOLICA ?? ""}</td>
      <td class="num">${r.ORA_GLICEMIA||""}</td>
      <td class="num">${r.GLUCOSIO ?? ""}</td>
      <td>${(r.NOTE||"")}</td>
    `;
    tbody.appendChild(tr);
  });

  $$("rowCount").textContent = String(rows.length);
}

async function load(){
  hideErr();
  try {
    setStatus("", "Carico CSVâ€¦");
    const url = CSV_URL + (CSV_URL.includes("?") ? "&" : "?") + "t=" + Date.now();
    const res = await fetch(url, { cache: "no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    const parsed = parseCSV(text);
    if(!parsed.rows.length) {
      const preview = text.slice(0, 300).replace(/\s+/g," ").trim();
      throw new Error("CSV letto ma nessuna riga riconosciuta. Anteprima: " + preview);
    }

    const mapped = parsed.rows.map(mapRow).filter(Boolean);
    const filtered = applyFilter(mapped);

    render(filtered);

    $$("lastUpdate").textContent = new Date().toLocaleString("it-CH");
    setStatus("ok", "OK");
  } catch(e) {
    setStatus("bad", "Errore");
    showErr(
      "Non riesco a leggere il CSV.\n\n" +
      "Dettagli: " + (e && e.message ? e.message : String(e)) + "\n\n" +
      "Test rapido: apri il link CSV in una scheda del browser: deve mostrarti testo CSV (righe con ;), non una pagina Dropbox."
    );
  }
}

function setFilter(mode, label){
  filterMode = mode;
  $$("filterPill").textContent = label;
  load();
}

$$("btnRefresh").addEventListener("click", load);
$$("btnShowAll").addEventListener("click", ()=>setFilter("all","Tutto"));
$$("btnLast25").addEventListener("click", ()=>setFilter("last25","Ultime 25"));
$$("btnLastMonth").addEventListener("click", ()=>setFilter("lastMonth","Ultimo mese"));

load();
setInterval(load, REFRESH_MS);
</script>
</body>
</html>
